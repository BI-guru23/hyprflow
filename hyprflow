#!/bin/bash

# Determine flow directory dynamically
FLOW_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WHISPER_DIR="${FLOW_DIR}/whisper.cpp"

if [ ! -d "$WHISPER_DIR" ]; then
  notify-send --urgency=critical "Error: WHISPER_DIR directory not found: $WHISPER_DIR"
  exit 1
fi

# Derive paths from WHISPER_DIR
WHISPER_BIN="${WHISPER_DIR}/whisper"
WHISPER_MODEL="${WHISPER_DIR}/models/ggml-base.en.bin"

# Check if whisper-cli exists
if [ ! -f "$WHISPER_BIN" ]; then
  notify-send --urgency=critical "Error: whisper-cli not found at: $WHISPER_BIN"
  exit 1
fi

# Check if model exists, if not try to find any model
if [ ! -f "$WHISPER_MODEL" ]; then
  # Try to find any ggml model
  if command -v fd &>/dev/null; then
    FOUND_MODEL=$(fd -t f 'ggml-.*\.bin$' "$WHISPER_DIR/models" | head -n1)
    if [ -n "$FOUND_MODEL" ]; then
      WHISPER_MODEL="$FOUND_MODEL"
    else
      notify-send --urgency=critical "Error: No Whisper model found in $WHISPER_DIR/models"
      exit 1
    fi
  else
    notify-send --urgency=critical "Error: Whisper model not found at: $WHISPER_MODEL"
    exit 1
  fi
fi

# Set defaults for other directories
RECORDING_DIR="${RECORDING_DIR:-${FLOW_DIR}/recordings}"
TRANSCRIPT_DIR="${TRANSCRIPT_DIR:-${FLOW_DIR}/transcripts}"
STATE_FILE="${STATE_FILE:-/tmp/hyprflow.state}"

# Validate other dependencies
if ! command -v pw-record &>/dev/null; then
  notify-send --urgency=critical "Error: pw-record not found. Install PipeWire."
  exit 1
fi

if ! command -v wl-copy &>/dev/null; then
  notify-send --urgency=critical "Error: wl-copy not found. Install wl-clipboard."
  exit 1
fi

mkdir -p "$RECORDING_DIR" "$TRANSCRIPT_DIR"

# Animation frames
FRAMES=(
  "⣾⣽⣻⢿⡿⣟⣯⣷"
  "⣽⣻⢿⡿⣟⣯⣷⣾"
  "⣻⢿⡿⣟⣯⣷⣾⣽"
  "⢿⡿⣟⣯⣷⣾⣽⣻"
  "⡿⣟⣯⣷⣾⣽⣻⢿"
  "⣟⣯⣷⣾⣽⣻⢿⡿"
  "⣯⣷⣾⣽⣻⢿⡿⣟"
  "⣷⣾⣽⣻⢿⡿⣟⣯"
)

start_animation() {
  # Start the animation in a background process
  (
    ID=$(notify-send --print-id --app-name=Flow --expire-time=0 "${FRAMES[0]}")
    echo "NOTIFY_ID=$ID" >>"$STATE_FILE"

    frame=0
    while true; do
      sleep 0.1
      notify-send --replace-id="$ID" --app-name=Flow --expire-time=0 "${FRAMES[$frame]}"
      frame=$(((frame + 1) % ${#FRAMES[@]}))
    done
  ) &

  ANIMATION_PID=$!
  echo "ANIMATION_PID=$ANIMATION_PID" >>"$STATE_FILE"
}

stop_animation() {
  if [ -f "$STATE_FILE" ]; then
    source "$STATE_FILE"
    if [ -n "$ANIMATION_PID" ] && kill -0 "$ANIMATION_PID" 2>/dev/null; then
      kill "$ANIMATION_PID" 2>/dev/null
    fi
    if [ -n "$NOTIFY_ID" ]; then
      notify-send --replace-id="$NOTIFY_ID" --app-name=Flow --expire-time=100 ""
    fi
  fi
}

if pgrep -f "pw-record.*hyprflow" >/dev/null 2>&1; then
  pkill -SIGINT -f "pw-record.*hyprflow"

  source "$STATE_FILE"
  RECORDING_FILE="${RECORDING_DIR}/${TIME}.wav"
  TRANSCRIPT_FILE="${TRANSCRIPT_DIR}/${TIME}_raw.txt"

  stop_animation

  "$WHISPER_BIN" -m "$WHISPER_MODEL" -f "$RECORDING_FILE" -nt -t "$(nproc)" 2>/dev/null >"$TRANSCRIPT_FILE"

  # Trim leading/trailing whitespace and copy to clipboard
  sed 's/^[[:space:]]*//;s/[[:space:]]*$//' "$TRANSCRIPT_FILE" | tr -d '\n' | wl-copy
  hyprctl dispatch sendshortcut "CTRL SHIFT, V, activewindow"
  rm -f "$STATE_FILE"
else
  TIME=$(date +%s)
  echo "TIME=$TIME" >"$STATE_FILE"
  RECORDING_FILE="${RECORDING_DIR}/${TIME}.wav"

  start_animation

  pw-record --rate 16000 --channels 1 "$RECORDING_FILE" 2>/dev/null &
fi

# Postprocessing not a priority right now.
# API_KEY="${GROQ_API_KEY:?Error: Please set API_KEY environment variable.}"
# MODEL="llama-3.3-70b-versatile"
# SYSTEM_PROMPT="System: You are an expert voice-to-text editor.
# Your goal is to rewrite the following transcript to be professional, concise, and grammatically correct.
# Rules:
# 1. Remove all filler words (um, ah, like, you know) and stutters.
# 2. Fix grammar and punctuation errors.
# 3. If the user lists multiple items, steps, or points, format them as a clean Markdown bulleted list.
# 4. Do not change the original meaning or tone.
# 5. Output ONLY the final polished text. No introductions like 'Here is the text'.
# "
